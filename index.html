<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>cris.ps | Discover the World's Best Potato Chips & Crisps</title>
    <meta name="description" content="Explore fascinating crisp and chip flavors from around the world. Discover today's featured chip, learn fun facts about snack history, and browse our global collection of unique potato chip varieties.">
    <meta name="keywords" content="potato chips, crisps, snack chips, chip flavors, international chips, chip of the day, snack guide, world chips">
    <meta name="robots" content="index, follow">
    <link rel="canonical" href="https://cris.ps/">
    
    <!-- Open Graph / Facebook -->
    <meta property="og:type" content="website">
    <meta property="og:url" content="https://cris.ps/">
    <meta property="og:title" content="cris.ps | Discover the World's Best Potato Chips & Crisps">
    <meta property="og:description" content="Explore fascinating crisp and chip flavors from around the world. Discover today's featured chip and learn fun facts about snack history.">
    <meta property="og:site_name" content="cris.ps">
    
    <!-- Twitter Card -->
    <meta name="twitter:card" content="summary">
    <meta name="twitter:url" content="https://cris.ps/">
    <meta name="twitter:title" content="cris.ps | Discover the World's Best Potato Chips & Crisps">
    <meta name="twitter:description" content="Explore fascinating crisp and chip flavors from around the world. Discover today's featured chip and learn fun facts about snack history.">
    
    <!-- Favicon -->
    <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
    <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
    
    <!-- JSON-LD Structured Data -->
    <script type="application/ld+json">
    {
        "@context": "https://schema.org",
        "@type": "WebSite",
        "name": "cris.ps",
        "alternateName": "Crisps - Your Ultimate Chip Guide",
        "url": "https://cris.ps/",
        "description": "Explore fascinating crisp and chip flavors from around the world",
        "potentialAction": {
            "@type": "SearchAction",
            "target": {
                "@type": "EntryPoint",
                "urlTemplate": "https://cris.ps/?search={search_term_string}"
            },
            "query-input": "required name=search_term_string"
        }
    }
    </script>
    <script type="application/ld+json">
    {
        "@context": "https://schema.org",
        "@type": "Organization",
        "name": "cris.ps",
        "url": "https://cris.ps/",
        "sameAs": []
    }
    </script>
    
    <!-- Google tag (gtag.js) -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-RZ0FJ2YVL5"></script>
    <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'G-RZ0FJ2YVL5');
    </script>
    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Fredoka:wght@400;500;600;700&family=Inter:wght@400;500;600&display=swap" rel="stylesheet">
    <!-- Tailwind CSS for styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        'display': ['Fredoka', 'sans-serif'],
                        'body': ['Inter', 'sans-serif'],
                    },
                    colors: {
                        'chip': {
                            50: '#fef7ee',
                            100: '#fdecd3',
                            200: '#fad5a5',
                            300: '#f6b76d',
                            400: '#f19132',
                            500: '#ed7512',
                            600: '#de5a08',
                            700: '#b84309',
                            800: '#93360f',
                            900: '#772f10',
                        },
                        'card': {
                            'blue': '#7DD3FC',
                            'green': '#4ADE80',
                            'orange': '#FB923C',
                            'red': '#F87171',
                            'teal': '#2DD4BF',
                        }
                    }
                }
            }
        }
    </script>
    <!-- Dexie.js: A wrapper for IndexedDB -->
    <script src="https://unpkg.com/dexie@3/dist/dexie.js"></script>
    <!-- marked.js: A Markdown to HTML parser -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <style>
        #article-view, #search-results, #inline-news { transition: opacity 0.3s ease-in-out; }
        .meter-segment { transition: background-color 0.3s ease; }
        .chip-swirl {
            background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 200 200' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath fill='%23F6B76D' fill-opacity='0.2' d='M44.7,-76.4C58.8,-69.2,71.8,-59.1,79.6,-45.8C87.4,-32.5,90,-16.3,88.5,-0.9C87,14.5,81.4,29,73.1,42.1C64.8,55.2,53.7,66.9,40.3,74.4C26.8,81.9,13.4,85.2,-0.8,86.6C-15,88,-30.1,87.5,-43.2,80.9C-56.3,74.3,-67.4,61.5,-74.5,47C-81.6,32.5,-84.6,16.3,-83.8,0.5C-83,-15.4,-78.4,-30.7,-70.3,-43.8C-62.3,-56.9,-50.8,-67.8,-37.6,-75.5C-24.4,-83.2,-12.2,-87.8,1.5,-90.3C15.2,-92.9,30.5,-83.5,44.7,-76.4Z' transform='translate(100 100)'/%3E%3C/svg%3E");
        }
        /* Bento Grid - positioned by JS bin-packing */
        .bento-container {
            position: relative;
            width: 100%;
        }
        .bento-item {
            position: absolute;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            border-radius: 1rem;
            padding: 1rem;
            overflow: hidden;
            box-sizing: border-box;
            transition: box-shadow 0.3s ease, filter 0.3s ease;
        }
        .bento-item:hover {
            box-shadow: 0 12px 24px -8px rgba(0,0,0,0.25);
            filter: brightness(1.05);
        }
    </style>
</head>
<body class="bg-amber-50/50 text-gray-800 font-body antialiased min-h-screen flex flex-col">

    <header class="bg-amber-50 border-b border-amber-100 sticky top-0 z-50">
        <div class="container mx-auto px-4 py-3 flex items-center justify-between gap-4">
            <!-- Logo -->
            <a href="index.html" class="flex-shrink-0">
                <h1 class="text-3xl font-display font-bold">
                    <span class="text-red-500">c</span><span class="text-orange-500">r</span><span class="text-yellow-500">i</span><span class="text-green-500">s</span><span class="text-gray-800">.</span><span class="text-blue-500">p</span><span class="text-purple-500">s</span>
                </h1>
            </a>
            
            <!-- Search Bar -->
            <div class="flex-1 max-w-xl">
                <div class="relative">
                    <svg class="absolute left-4 top-1/2 -translate-y-1/2 w-5 h-5 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path></svg>
                    <input type="text" id="search-input" placeholder="Search ingredients..."
                           class="w-full py-2.5 pl-12 pr-4 text-base bg-white border border-gray-200 rounded-full focus:ring-2 focus:ring-orange-300 focus:border-orange-300 outline-none transition duration-200">
                </div>
            </div>
            
            <!-- Right Icons -->
            <div class="flex items-center gap-3 flex-shrink-0">
                <a href="origins.html" class="w-10 h-10 flex items-center justify-center hover:bg-amber-100 rounded-full transition-colors" title="Ingredient Origins">
                    <span class="text-2xl">üåç</span>
                </a>
                <button class="w-10 h-10 flex items-center justify-center hover:bg-amber-100 rounded-full transition-colors" title="Account">
                    <svg class="w-6 h-6 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path></svg>
                </button>
            </div>
        </div>
    </header>


    <main class="container mx-auto px-4 py-8 flex-1">
        <!-- Main Grid Layout -->
        <div class="flex flex-col lg:flex-row gap-8">
            
            <!-- Left Column: Chip of the Day -->
            <div class="lg:w-[420px] flex-shrink-0">
                <section id="chip-of-the-day" class="bg-gradient-to-br from-amber-100 via-orange-50 to-amber-50 rounded-3xl p-6 shadow-xl relative overflow-hidden border border-orange-200/50">
                    <!-- Decorative background elements -->
                    <div class="absolute inset-0 opacity-20">
                        <div class="absolute -top-10 -left-10 w-32 h-32 bg-orange-400 rounded-full blur-2xl"></div>
                        <div class="absolute -bottom-10 -right-10 w-40 h-40 bg-amber-400 rounded-full blur-2xl"></div>
                    </div>
                    
                    <!-- Chip Content -->
                    <div id="chip-of-day-content" class="relative">
                        <div class="flex flex-col items-center">
                            <div class="inline-flex items-center gap-2 bg-orange-500 text-white text-xs font-bold px-3 py-1.5 rounded-full mb-5 shadow-md">
                                <span>‚ú®</span>
                                <span class="locale-chip-of-day">Chip of the Day</span>
                            </div>
                            <div class="animate-pulse w-24 h-24 bg-gradient-to-br from-amber-200 to-orange-200 rounded-2xl flex items-center justify-center shadow-md mb-5">
                                <span class="text-4xl">ü•î</span>
                            </div>
                            <p class="text-gray-500 text-sm locale-discovering">Discovering today's chip...</p>
                        </div>
                    </div>
                    
                </section>
            </div>
            
            <!-- Right Column: Content Area -->
            <div class="flex-1 min-w-0">
                <div id="content-area">
                    <!-- Loading Status -->
                    <div id="status" class="text-center py-16">
                        <div class="relative inline-block">
                            <div id="status-spinner" class="animate-spin rounded-full h-16 w-16 border-4 border-orange-200 border-t-orange-500 mx-auto mb-4"></div>
                            <span class="absolute inset-0 flex items-center justify-center text-2xl">ü•î</span>
                        </div>
                        <p id="status-text" class="font-medium text-gray-600">Loading the crunchiest database...</p>
                    </div>

                    <!-- News Grid -->
                    <div id="inline-news" class="hidden">
                        <h2 class="text-2xl font-display font-bold text-gray-800 mb-6 locale-news-heading">Latest Chip News</h2>
                        <div id="inline-news-articles" class="bento-container">
                            <p class="text-gray-500">Loading news...</p>
                        </div>
                    </div>

                    <!-- Search Results -->
                    <div id="search-results" class="hidden"></div>

                    <!-- Article View -->
                    <div id="article-view" class="hidden bg-white rounded-2xl p-6 shadow-lg">
                        <button id="back-button" class="mb-6 inline-flex items-center gap-2 bg-gray-100 hover:bg-gray-200 text-gray-700 py-2 px-4 rounded-xl font-medium transition-colors">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path></svg>
                            Back
                        </button>
                        <article id="article-content" class="prose lg:prose-xl max-w-none prose-headings:font-display"></article>
                    </div>
                    
                    <!-- Chip History View -->
                    <div id="chip-history-view" class="hidden">
                        <div class="flex items-center justify-between mb-6">
                            <h2 class="text-2xl font-display font-bold text-gray-800 locale-history-heading">Chip History</h2>
                            <button id="history-back-button" class="inline-flex items-center gap-2 bg-gray-100 hover:bg-gray-200 text-gray-700 py-2 px-4 rounded-xl font-medium transition-colors text-sm">
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path></svg>
                                Back
                            </button>
                        </div>
                        <div id="chip-history-content" class="space-y-4">
                            <p class="text-gray-500">Loading history...</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <footer class="bg-amber-50 border-t border-amber-100 py-6 mt-auto">
        <div class="container mx-auto px-4">
            <div class="flex flex-col md:flex-row items-center justify-between gap-4">
                <!-- Social Icons -->
                <div class="flex items-center gap-3">
                    <a href="#" class="w-8 h-8 bg-gray-700 hover:bg-gray-600 rounded-full flex items-center justify-center transition-colors">
                        <svg class="w-4 h-4 text-white" fill="currentColor" viewBox="0 0 24 24"><path d="M24 12.073c0-6.627-5.373-12-12-12s-12 5.373-12 12c0 5.99 4.388 10.954 10.125 11.854v-8.385H7.078v-3.47h3.047V9.43c0-3.007 1.792-4.669 4.533-4.669 1.312 0 2.686.235 2.686.235v2.953H15.83c-1.491 0-1.956.925-1.956 1.874v2.25h3.328l-.532 3.47h-2.796v8.385C19.612 23.027 24 18.062 24 12.073z"/></svg>
                    </a>
                    <a href="#" class="w-8 h-8 bg-gray-700 hover:bg-gray-600 rounded-full flex items-center justify-center transition-colors">
                        <svg class="w-4 h-4 text-white" fill="currentColor" viewBox="0 0 24 24"><path d="M12 2.163c3.204 0 3.584.012 4.85.07 3.252.148 4.771 1.691 4.919 4.919.058 1.265.069 1.645.069 4.849 0 3.205-.012 3.584-.069 4.849-.149 3.225-1.664 4.771-4.919 4.919-1.266.058-1.644.07-4.85.07-3.204 0-3.584-.012-4.849-.07-3.26-.149-4.771-1.699-4.919-4.92-.058-1.265-.07-1.644-.07-4.849 0-3.204.013-3.583.07-4.849.149-3.227 1.664-4.771 4.919-4.919 1.266-.057 1.645-.069 4.849-.069zm0-2.163c-3.259 0-3.667.014-4.947.072-4.358.2-6.78 2.618-6.98 6.98-.059 1.281-.073 1.689-.073 4.948 0 3.259.014 3.668.072 4.948.2 4.358 2.618 6.78 6.98 6.98 1.281.058 1.689.072 4.948.072 3.259 0 3.668-.014 4.948-.072 4.354-.2 6.782-2.618 6.979-6.98.059-1.28.073-1.689.073-4.948 0-3.259-.014-3.667-.072-4.947-.196-4.354-2.617-6.78-6.979-6.98-1.281-.059-1.69-.073-4.949-.073zm0 5.838c-3.403 0-6.162 2.759-6.162 6.162s2.759 6.163 6.162 6.163 6.162-2.759 6.162-6.163c0-3.403-2.759-6.162-6.162-6.162zm0 10.162c-2.209 0-4-1.79-4-4 0-2.209 1.791-4 4-4s4 1.791 4 4c0 2.21-1.791 4-4 4zm6.406-11.845c-.796 0-1.441.645-1.441 1.44s.645 1.44 1.441 1.44c.795 0 1.439-.645 1.439-1.44s-.644-1.44-1.439-1.44z"/></svg>
                    </a>
                    <a href="#" class="w-8 h-8 bg-gray-700 hover:bg-gray-600 rounded-full flex items-center justify-center transition-colors">
                        <svg class="w-4 h-4 text-white" fill="currentColor" viewBox="0 0 24 24"><path d="M23.498 6.186a3.016 3.016 0 0 0-2.122-2.136C19.505 3.545 12 3.545 12 3.545s-7.505 0-9.377.505A3.017 3.017 0 0 0 .502 6.186C0 8.07 0 12 0 12s0 3.93.502 5.814a3.016 3.016 0 0 0 2.122 2.136c1.871.505 9.376.505 9.376.505s7.505 0 9.377-.505a3.015 3.015 0 0 0 2.122-2.136C24 15.93 24 12 24 12s0-3.93-.502-5.814zM9.545 15.568V8.432L15.818 12l-6.273 3.568z"/></svg>
                    </a>
                    <a href="#" class="w-8 h-8 bg-gray-700 hover:bg-gray-600 rounded-full flex items-center justify-center transition-colors">
                        <svg class="w-4 h-4 text-white" fill="currentColor" viewBox="0 0 24 24"><path d="M12.525.02c1.31-.02 2.61-.01 3.91-.02.08 1.53.63 3.09 1.75 4.17 1.12 1.11 2.7 1.62 4.24 1.79v4.03c-1.44-.05-2.89-.35-4.2-.97-.57-.26-1.1-.59-1.62-.93-.01 2.92.01 5.84-.02 8.75-.08 1.4-.54 2.79-1.35 3.94-1.31 1.92-3.58 3.17-5.91 3.21-1.43.08-2.86-.31-4.08-1.03-2.02-1.19-3.44-3.37-3.65-5.71-.02-.5-.03-1-.01-1.49.18-1.9 1.12-3.72 2.58-4.96 1.66-1.44 3.98-2.13 6.15-1.72.02 1.48-.04 2.96-.04 4.44-.99-.32-2.15-.23-3.02.37-.63.41-1.11 1.04-1.36 1.75-.21.51-.15 1.07-.14 1.61.24 1.64 1.82 3.02 3.5 2.87 1.12-.01 2.19-.66 2.77-1.61.19-.33.4-.67.41-1.06.1-1.79.06-3.57.07-5.36.01-4.03-.01-8.05.02-12.07z"/></svg>
                    </a>
                </div>
                
                <!-- Navigation Links -->
                <nav class="flex items-center gap-6">
                    <a href="origins.html" class="text-gray-600 hover:text-gray-800 font-medium transition-colors">Origins Map</a>
                    <a href="#" id="footer-history-link" class="text-gray-600 hover:text-gray-800 font-medium transition-colors">Chip History</a>
                </nav>
                
                <!-- Copyright -->
                <div class="text-right text-sm text-gray-500">
                    <p>¬© 2025 cris.ps. All rights reserved.</p>
                    <p class="text-xs">Spreading joy, one crunch at a time.</p>
                </div>
            </div>
        </div>
    </footer>


    <script>
        // --- DATABASE SETUP (Dexie.js) ---
        const db = new Dexie('EncyclopediaDB');
        db.version(3).stores({
            articles: 'id, title, content',
            invertedIndex: 'word, *ids'
        });

        // --- LOCALE DETECTION (UK/Ireland use "crisps") ---
        const isUKLocale = (() => {
            const lang = navigator.language || navigator.userLanguage || '';
            const tz = Intl.DateTimeFormat().resolvedOptions().timeZone || '';
            // Check for UK/Ireland language codes or timezones
            const ukLangCodes = ['en-GB', 'en-IE', 'en-gb', 'en-ie'];
            const ukTimezones = ['Europe/London', 'Europe/Dublin'];
            return ukLangCodes.some(code => lang.startsWith(code)) || 
                   ukTimezones.includes(tz);
        })();
        
        // Localization helper - converts chip terminology for UK/Ireland
        const L = {
            chip: isUKLocale ? 'Crisp' : 'Chip',
            chips: isUKLocale ? 'Crisps' : 'Chips',
            CHIP: isUKLocale ? 'CRISP' : 'CHIP',
            CHIPS: isUKLocale ? 'CRISPS' : 'CHIPS',
        };

        // --- UI ELEMENTS ---
        const statusDiv = document.getElementById('status');
        const statusText = document.getElementById('status-text');
        const statusSpinner = document.getElementById('status-spinner');
        const searchInput = document.getElementById('search-input');
        const searchResultsDiv = document.getElementById('search-results');
        const articleViewDiv = document.getElementById('article-view');
        const articleContentDiv = document.getElementById('article-content');

        // Card colors for news grid - warm chip-themed palette
        const cardColors = [
            { bg: 'bg-amber-100', text: 'text-amber-900' },
            { bg: 'bg-orange-100', text: 'text-orange-900' },
            { bg: 'bg-yellow-100', text: 'text-yellow-900' },
            { bg: 'bg-amber-200', text: 'text-amber-900' },
            { bg: 'bg-orange-50', text: 'text-orange-900' },
            { bg: 'bg-yellow-50', text: 'text-yellow-900' },
        ];
        
        function getTimeAgo(dateString) {
            if (!dateString) return 'Recent';
            const date = new Date(dateString);
            if (isNaN(date.getTime())) return 'Recent';
            const now = new Date();
            const diffMs = now - date;
            const diffHours = Math.floor(diffMs / (1000 * 60 * 60));
            const diffDays = Math.floor(diffMs / (1000 * 60 * 60 * 24));
            
            if (diffHours < 1) return 'Just now';
            if (diffHours < 24) return `${diffHours} hours ago`;
            if (diffDays === 1) return '1 day ago';
            return `${diffDays} days ago`;
        }

        // --- NEWS SECTION ---
        async function loadNews() {
            const inlineNewsDiv = document.getElementById('inline-news-articles');
            try {
                const response = await fetch('news.json');
                if (!response.ok) throw new Error('News not available');
                const newsData = await response.json();
                if (!newsData || newsData.length === 0) {
                    inlineNewsDiv.innerHTML = '<p class="text-gray-500">No news found.</p>';
                    return;
                }
                
                // Seeded random based on days since Unix epoch
                const daysSinceEpoch = Math.floor(Date.now() / (1000 * 60 * 60 * 24));
                const seededRandom = (seed) => {
                    const x = Math.sin(seed) * 10000;
                    return x - Math.floor(x);
                };
                
                // Heights: 1, 2, or 3 units (no wide boxes - swim lane style)
                const getHeight = (index) => {
                    const seed = daysSinceEpoch * 100 + index;
                    const rand = seededRandom(seed);
                    if (rand < 0.5) return 1;      // 50% small
                    if (rand < 0.8) return 2;      // 30% medium
                    return 3;                       // 20% tall
                };
                
                // Placeholder chip images (using picsum with seed for consistency)
                const getImageUrl = (index) => {
                    const seed = daysSinceEpoch * 12 + index;
                    return `https://picsum.photos/seed/${seed}/200/200`;
                };
                
                let html = '';
                const displayNews = newsData.slice(0, 12);
                displayNews.forEach((article, index) => {
                    const color = cardColors[index % cardColors.length];
                    const timeAgo = getTimeAgo(article.publishedAt);
                    const h = getHeight(index);
                    const imageUrl = article.imageUrl || getImageUrl(index);
                    const imgSize = h === 1 ? '40px' : (h === 2 ? '70px' : '100px');
                    const snippet = article.snippet || '';
                    const showSnippet = h >= 2 && snippet;
                    
                    html += `<a href="${article.url}" target="_blank" 
                        class="bento-item ${color.bg}" data-h="${h}">
                        <div class="flex justify-center">
                            <img src="${imageUrl}" alt="" class="rounded-xl object-cover shadow-sm" style="height: ${imgSize}; width: auto; max-width: 70%;">
                        </div>
                        <div class="flex-1 flex flex-col justify-between mt-2 overflow-hidden">
                            <div class="overflow-hidden">
                                <h3 class="font-bold text-sm ${color.text} leading-tight line-clamp-2">${article.title}</h3>
                                ${showSnippet ? `<p class="text-xs ${color.text} opacity-70 mt-1 overflow-hidden" style="display: -webkit-box; -webkit-line-clamp: ${h === 2 ? 2 : 4}; -webkit-box-orient: vertical;">${snippet}</p>` : ''}
                            </div>
                            <p class="text-xs ${color.text} opacity-60 pt-1">${timeAgo}</p>
                        </div>
                    </a>`;
                });
                inlineNewsDiv.innerHTML = html;
                
                // initBentoGrid will be called after showView makes container visible
            } catch (err) {
                inlineNewsDiv.innerHTML = `<p class="text-red-500">Failed to load news: ${err.message}</p>`;
            }
        }
        
        function initBentoGrid() {
            const container = document.querySelector('#inline-news-articles');
            const items = Array.from(container.querySelectorAll('.bento-item'));
            const gap = 16;
            const rowHeight = 140;
            
            const layout = () => {
                const containerWidth = container.getBoundingClientRect().width;
                const cols = containerWidth > 768 ? 3 : 2;
                const colWidth = (containerWidth - (cols - 1) * gap) / cols;
                
                // Track height of each column
                const colHeights = new Array(cols).fill(0);
                
                items.forEach((item, index) => {
                    // Find shortest column
                    const col = colHeights.indexOf(Math.min(...colHeights));
                    const h = parseInt(item.dataset.h) || 1;
                    
                    const pxX = col * (colWidth + gap);
                    const pxY = colHeights[col];
                    const itemHeight = h * rowHeight + (h - 1) * gap;
                    
                    item.style.transform = `translate(${pxX}px, ${pxY}px)`;
                    item.style.width = `${colWidth}px`;
                    item.style.height = `${itemHeight}px`;
                    
                    colHeights[col] += itemHeight + gap;
                });
                
                container.style.height = Math.max(...colHeights) + 'px';
            };
            
            layout();
            window.addEventListener('resize', layout);
        }

        // --- CHIP OF THE DAY SECTION ---
        async function loadChipOfTheDay() {
            const chipDiv = document.getElementById('chip-of-day-content');
            
            try {
                const response = await fetch('chip_of_the_day.json');
                if (!response.ok) throw new Error(`${L.chip} of the day not available`);
                const chipsData = await response.json();
                
                // Find today's chip from the array (supports timezone differences)
                const today = new Date();
                const todayStr = today.toISOString().split('T')[0]; // YYYY-MM-DD
                
                // Handle both array (new format) and single object (old format)
                let chipData;
                if (Array.isArray(chipsData)) {
                    chipData = chipsData.find(c => c.date === todayStr);
                    // Fallback to first chip if today's not found
                    if (!chipData && chipsData.length > 0) {
                        chipData = chipsData[0];
                    }
                } else {
                    chipData = chipsData;
                }
                
                if (!chipData) {
                    throw new Error(`No ${L.chip.toLowerCase()} data available`);
                }
                
                // Create Google search URL (use "chips" for search since that's the global term)
                const searchTerm = isUKLocale ? 'crisps' : 'chips';
                const searchUrl = `https://www.google.com/search?q=${encodeURIComponent('"' + chipData.chip_name + '" ' + searchTerm)}`;
                
                // Format today's date
                const dateStr = today.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
                
                // Build Wikipedia URL for the date (e.g., https://en.wikipedia.org/wiki/December_11)
                const monthName = today.toLocaleDateString('en-US', { month: 'long' });
                const dayNum = today.getDate();
                const wikipediaDateUrl = `https://en.wikipedia.org/wiki/${monthName}_${dayNum}`;
                
                // Date display - link to Wikipedia date page
                const dateHtml = `<a href="${wikipediaDateUrl}" target="_blank" class="opacity-75 font-normal hover:opacity-100 hover:underline transition-opacity">${dateStr}</a>`;
                
                // Chip image or fallback emoji
                const chipImageHtml = chipData.image_url
                    ? `<img src="${chipData.image_url}" alt="${chipData.chip_name}" class="w-32 h-32 object-contain rounded-2xl bg-white shadow-md" onerror="this.outerHTML='<div class=\\'w-24 h-24 bg-gradient-to-br from-amber-200 to-orange-300 rounded-2xl flex items-center justify-center shadow-md\\'><span class=\\'text-4xl\\'>ü•î</span></div>'">`
                    : `<div class="w-24 h-24 bg-gradient-to-br from-amber-200 to-orange-300 rounded-2xl flex items-center justify-center shadow-md">
                            <span class="text-4xl">ü•î</span>
                       </div>`;
                
                // Event reference link (if available)
                const eventLinkHtml = chipData.event_url
                    ? `<a href="${chipData.event_url}" target="_blank" class="text-orange-500 hover:text-orange-600 hover:underline text-xs">[ref]</a>`
                    : '';
                
                chipDiv.innerHTML = `
                    <div class="flex flex-col items-center">
                        <!-- Badge -->
                        <div class="inline-flex items-center gap-2 bg-orange-500 text-white text-xs font-bold px-3 py-1.5 rounded-full mb-5 shadow-md">
                            <span>‚ú®</span>
                            <span>${L.chip} of the Day</span>
                            <span class="opacity-75">‚Ä¢</span>
                            ${dateHtml}
                        </div>
                        
                        <!-- Image -->
                        <a href="${searchUrl}" target="_blank" class="mb-5 hover:scale-105 transition-transform">
                            ${chipImageHtml}
                        </a>
                        
                        <!-- Name -->
                        <h3 class="text-2xl font-display font-bold text-gray-800 mb-3 text-center">
                            <a href="${searchUrl}" target="_blank" class="hover:text-orange-600 transition-colors">${chipData.chip_name}</a>
                        </h3>
                        
                        <!-- Description with event reference -->
                        <!--
                        <p class="text-gray-600 text-sm leading-relaxed text-center mb-5">${chipData.description} ${eventLinkHtml}</p>
                        -->
                        <!-- History link -->
                        <a href="#" id="chip-history-link" class="inline-flex items-center gap-1.5 text-xs text-orange-500 hover:text-orange-600 font-medium transition-colors bg-orange-50 px-3 py-1.5 rounded-full">
                            <span>üìú</span> View history
                        </a>
                    </div>
                `;
                
                // Attach history link click handler
                document.getElementById('chip-history-link').addEventListener('click', (e) => {
                    e.preventDefault();
                    loadChipHistory();
                });
                
            } catch (err) {
                chipDiv.innerHTML = `
                    <div class="text-center py-4">
                        <div class="inline-block bg-gray-400 text-white text-xs font-bold px-3 py-1 rounded-full mb-4">
                            ${L.chip} of the Day
                        </div>
                        <div class="w-24 h-24 mx-auto bg-gradient-to-br from-gray-200 to-gray-300 rounded-full flex items-center justify-center shadow-lg mb-4">
                            <span class="text-4xl">ü•î</span>
                        </div>
                        <p class="text-gray-500 text-sm">No ${L.chip.toLowerCase()} of the day yet</p>
                    </div>
                `;
            }
        }

        // --- CHIP HISTORY SECTION ---
        async function loadChipHistory() {
            const historyContent = document.getElementById('chip-history-content');
            historyContent.innerHTML = '<p class="text-gray-500">Loading history...</p>';
            showView('chip-history');
            
            try {
                const response = await fetch('chip_history.json');
                if (!response.ok) throw new Error('History not available');
                let history = await response.json();
                
                // Filter out future dates (we generate chips ahead for timezone support)
                const today = new Date();
                today.setHours(23, 59, 59, 999); // End of today
                history = history.filter(chip => new Date(chip.date) <= today);
                
                // Sort by date descending (most recent first)
                history.sort((a, b) => new Date(b.date) - new Date(a.date));
                
                let html = '<div class="grid gap-3">';
                history.forEach((chip, index) => {
                    const isEven = index % 2 === 0;
                    const bgColor = isEven ? 'bg-amber-100' : 'bg-orange-50';
                    const textColor = 'text-amber-900';
                    const searchUrl = `https://www.google.com/search?q=${encodeURIComponent('"' + chip.chip_name + '" chips')}`;
                    const dateStr = new Date(chip.date).toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
                    
                    // Image or emoji fallback
                    const imageHtml = chip.image_url
                        ? `<img src="${chip.image_url}" alt="${chip.chip_name}" class="w-12 h-12 object-contain rounded-lg bg-white" onerror="this.outerHTML='<div class=\\'w-10 h-10 bg-white/50 rounded-lg flex items-center justify-center\\'><span class=\\'text-lg\\'>ü•î</span></div>'">`
                        : `<div class="w-10 h-10 bg-white/50 rounded-lg flex items-center justify-center">
                                <span class="text-lg">ü•î</span>
                           </div>`;
                    
                    html += `
                        <div class="${bgColor} rounded-xl p-4 shadow-sm hover:shadow-md transition-shadow">
                            <div class="flex items-start gap-3">
                                <div class="flex-shrink-0">
                                    ${imageHtml}
                                </div>
                                <div class="flex-1 min-w-0">
                                    <div class="flex items-center gap-2 mb-1">
                                        <span class="text-xs ${textColor} opacity-60">${dateStr}</span>
                                    </div>
                                    <h3 class="font-bold ${textColor}">
                                        <a href="${searchUrl}" target="_blank" class="hover:underline">${chip.chip_name}</a>
                                    </h3>
                                    <!--
                                    <p class="text-sm ${textColor} opacity-80 mt-1">${chip.description || ''}</p>
                                    -->
                                </div>
                            </div>
                        </div>
                    `;
                });
                html += '</div>';
                historyContent.innerHTML = html;
                
            } catch (err) {
                historyContent.innerHTML = `
                    <div class="text-center py-8">
                        <span class="text-4xl mb-4 block">üì≠</span>
                        <p class="text-gray-500">No ${L.chip.toLowerCase()} history available</p>
                    </div>
                `;
            }
        }

        // --- APPLY LOCALE TO STATIC HTML ---
        function applyLocale() {
            // Update static text elements with locale-aware versions
            const updates = {
                '.locale-chip-of-day': `${L.chip} of the Day`,
                '.locale-discovering': `Discovering today's ${L.chip.toLowerCase()}...`,
                '.locale-news-heading': `Latest ${L.chip} News`,
                '.locale-history-heading': `${L.chip} History`,
            };
            for (const [selector, text] of Object.entries(updates)) {
                const el = document.querySelector(selector);
                if (el) el.textContent = text;
            }
        }

        window.addEventListener('DOMContentLoaded', async () => {
            applyLocale();
            await loadNews();
            showView('news');
            initBentoGrid();
            loadChipOfTheDay();
            
            // History back button
            document.getElementById('history-back-button').addEventListener('click', () => {
                showView('news');
            });
        });
        
        const backButton = document.getElementById('back-button');

        // --- CORE LOGIC ---
        function tokenize(text) {
            const stopWords = new Set(['a', 'an', 'the', 'and', 'it', 'is', 'in', 'of', 'to', 'for', 'on', 'with', 'as', 'by', 'at']);
            return text
                .toLowerCase()
                .replace(/[^\w\s]/g, '')
                .split(/\s+/)
                .filter(word => word.length > 2 && !stopWords.has(word));
        }

        async function buildIndex(chipData) {
            statusText.textContent = 'Indexing content...';
            const articleIds = Object.keys(chipData);
            const invertedIndex = {};
            
            for (let i = 0; i < articleIds.length; i++) {
                const id = articleIds[i];
                statusText.textContent = `Indexing article ${i + 1} of ${articleIds.length}: ${id}`;
                
                const articleData = chipData[id];
                const { title, content } = articleData;
                
                await db.articles.put({ id, title, content });

                const uniqueWords = new Set(tokenize(title + ' ' + content));
                uniqueWords.forEach(word => {
                    if (!invertedIndex[word]) {
                        invertedIndex[word] = [];
                    }
                    invertedIndex[word].push(id);
                });
            }
            
            statusText.textContent = 'Saving index to database...';
            const indexEntries = Object.entries(invertedIndex).map(([word, ids]) => ({ word, ids }));
            await db.invertedIndex.bulkPut(indexEntries);

            console.log('Indexing complete!');
        }
        
        async function search(query) {
            const cleanQuery = query.toLowerCase().trim();
            if (cleanQuery.length < 3) {
                searchResultsDiv.innerHTML = '<p class="text-gray-500 text-center py-8">Please enter at least 3 characters.</p>';
                showView('search');
                return;
            }
            
            const result = await db.invertedIndex.get(cleanQuery);
            
            if (result && result.ids.length > 0) {
                const articles = await db.articles.where('id').anyOf(result.ids).toArray();
                let html = `<div class="mb-6">
                    <h2 class="text-2xl font-display font-bold text-gray-800">Results for "${cleanQuery}"</h2>
                    <p class="text-gray-500">${articles.length} chips found</p>
                </div>`;
                html += '<div class="grid grid-cols-1 md:grid-cols-2 gap-4">';
                articles.forEach((article, index) => {
                    const color = cardColors[index % cardColors.length];
                    html += `
                        <div class="news-card ${color.bg} rounded-2xl p-5 cursor-pointer" data-id="${article.id}">
                            <h3 class="font-bold text-lg ${color.text}">${article.title}</h3>
                            <p class="text-sm ${color.text} opacity-70 mt-2">${article.content.substring(0, 80)}...</p>
                        </div>
                    `;
                });
                html += '</div>';
                searchResultsDiv.innerHTML = html;
            } else {
                searchResultsDiv.innerHTML = `<div class="text-center py-16">
                    <span class="text-6xl mb-4 block">ü§î</span>
                    <p class="text-xl text-gray-600">No chips found for "${cleanQuery}"</p>
                    <p class="text-gray-400 mt-2">Try a different search term</p>
                </div>`;
            }
            showView('search');
        }

        async function displayArticle(id) {
            const article = await db.articles.get(id);
            if (article) {
                articleContentDiv.innerHTML = marked.parse(article.content);
                showView('article');
            }
        }
        
        function showView(viewName) {
            const inlineNewsDiv = document.getElementById('inline-news');
            const chipHistoryDiv = document.getElementById('chip-history-view');
            articleViewDiv.classList.add('hidden', 'opacity-0');
            searchResultsDiv.classList.add('hidden', 'opacity-0');
            statusDiv.classList.add('hidden');
            inlineNewsDiv.classList.add('hidden');
            chipHistoryDiv.classList.add('hidden');
            
            if (viewName === 'search') {
                searchResultsDiv.classList.remove('hidden');
                setTimeout(() => searchResultsDiv.classList.remove('opacity-0'), 10);
            } else if (viewName === 'article') {
                articleViewDiv.classList.remove('hidden');
                setTimeout(() => articleViewDiv.classList.remove('opacity-0'), 10);
            } else if (viewName === 'news') {
                inlineNewsDiv.classList.remove('hidden');
            } else if (viewName === 'chip-history') {
                chipHistoryDiv.classList.remove('hidden');
            }
        }
        
        // --- EVENT LISTENERS ---
        let searchTimeout;
        searchInput.addEventListener('input', () => {
            clearTimeout(searchTimeout);
            searchTimeout = setTimeout(() => {
                const query = searchInput.value;
                if (query) {
                    search(query);
                } else {
                    showView('news');
                }
            }, 300);
        });
        
        searchResultsDiv.addEventListener('click', (e) => {
            const card = e.target.closest('[data-id]');
            if (card && card.dataset.id) {
                displayArticle(card.dataset.id);
            }
        });
        
        backButton.addEventListener('click', () => {
             showView('search');
        });

        // --- INITIALIZATION ---
        async function initialize() {
            try {
                await db.open(); 
                // Always clear the database and re-index
                await db.articles.clear();
                await db.invertedIndex.clear();
                console.log('Database cleared. Loading chip data from JSON file.');
                
                // Fetch the chip data from JSON file
                const response = await fetch('chip-data.json');
                const chipData = await response.json();
                
                await buildIndex(chipData);
            } catch (error) {
                 console.error("Failed to initialize database:", error);
                 console.log("Attempting to recover by deleting database and re-indexing.");
                 await db.close();
                 await db.delete();
                 await db.open();

                 // Fetch the chip data from JSON file
                 const response = await fetch('chip-data.json');
                 const chipData = await response.json();

                 await buildIndex(chipData);
            } finally {
                statusDiv.classList.add('hidden');
                showView('news');
            }
        }

        window.onload = initialize;
    </script>
</body>
</html>
