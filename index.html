<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>The Chip-cyclopedia | Your Ultimate Crisp Guide</title>
    <!-- Google tag (gtag.js) -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-RZ0FJ2YVL5"></script>
    <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'G-RZ0FJ2YVL5');
    </script>
    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Fredoka:wght@400;500;600;700&family=Inter:wght@400;500;600&display=swap" rel="stylesheet">
    <!-- Tailwind CSS for styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        'display': ['Fredoka', 'sans-serif'],
                        'body': ['Inter', 'sans-serif'],
                    },
                    colors: {
                        'chip': {
                            50: '#fef7ee',
                            100: '#fdecd3',
                            200: '#fad5a5',
                            300: '#f6b76d',
                            400: '#f19132',
                            500: '#ed7512',
                            600: '#de5a08',
                            700: '#b84309',
                            800: '#93360f',
                            900: '#772f10',
                        },
                        'crisp': {
                            50: '#f0fdf4',
                            100: '#dcfce7',
                            200: '#bbf7d0',
                            300: '#86efac',
                            400: '#4ade80',
                            500: '#22c55e',
                        }
                    }
                }
            }
        }
    </script>
    <!-- Dexie.js: A wrapper for IndexedDB -->
    <script src="https://unpkg.com/dexie@3/dist/dexie.js"></script>
    <!-- marked.js: A Markdown to HTML parser -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <style>
        #article-view, #search-results, #inline-news { transition: opacity 0.3s ease-in-out; }
        .news-card:hover { transform: translateY(-2px); }
        .glass-effect {
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
        }
        .chip-pattern {
            background-image: url("data:image/svg+xml,%3Csvg width='60' height='60' viewBox='0 0 60 60' xmlns='http://www.w3.org/2000/svg'%3E%3Cg fill='none' fill-rule='evenodd'%3E%3Cg fill='%23f6b76d' fill-opacity='0.15'%3E%3Cpath d='M36 34v-4h-2v4h-4v2h4v4h2v-4h4v-2h-4zm0-30V0h-2v4h-4v2h4v4h2V6h4V4h-4zM6 34v-4H4v4H0v2h4v4h2v-4h4v-2H6zM6 4V0H4v4H0v2h4v4h2V6h4V4H6z'/%3E%3C/g%3E%3C/g%3E%3C/svg%3E");
        }
    </style>
</head>
<body class="bg-gradient-to-br from-amber-50 via-orange-50 to-yellow-50 text-gray-800 font-body antialiased min-h-screen chip-pattern">

    <div class="container mx-auto p-4 md:p-8 max-w-6xl">
        <!-- Header with fun branding -->
        <header class="mb-10 text-center relative">
            <div class="inline-block">
                <h1 class="text-5xl md:text-6xl font-display font-bold bg-gradient-to-r from-chip-600 via-chip-500 to-amber-500 bg-clip-text text-transparent drop-shadow-sm">
                    The Chip-cyclopedia
                </h1>
                <div class="flex items-center justify-center gap-2 mt-3">
                    <span class="text-2xl">ü•î</span>
                    <p class="text-gray-600 font-medium">Your ultimate guide to the world of crisps</p>
                    <span class="text-2xl">‚ú®</span>
                </div>
            </div>
        </header>

        <!-- Two-column layout -->
        <div class="flex flex-col-reverse lg:flex-row lg:gap-8">
            
            <!-- Main Content Column -->
            <div class="lg:flex-1 lg:max-w-2xl">
                <!-- Search Bar - Elevated Design -->
                <div class="relative mb-6 mt-6 lg:mt-0 group">
                    <div class="absolute inset-0 bg-gradient-to-r from-chip-400 to-amber-400 rounded-2xl blur-xl opacity-30 group-hover:opacity-50 transition-opacity"></div>
                    <div class="relative">
                        <input type="text" id="search-input" placeholder="Search for chips like 'kettle', 'jalape√±o', or 'truffle'..."
                               class="w-full p-5 pl-14 text-lg bg-white/90 glass-effect border-0 rounded-2xl shadow-lg focus:ring-4 focus:ring-chip-200 outline-none transition duration-300 placeholder-gray-400">
                        <svg class="w-6 h-6 absolute left-5 top-1/2 -translate-y-1/2 text-chip-400" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path></svg>
                    </div>
                </div>

                <!-- Main Content Area -->
                <main id="content-area" class="bg-white/80 glass-effect p-6 md:p-8 rounded-2xl shadow-xl min-h-[400px] border border-white/50">
                    <!-- Indexing Status -->
                    <div id="status" class="text-center text-gray-500 p-8">
                        <div class="relative inline-block">
                            <div id="status-spinner" class="animate-spin rounded-full h-16 w-16 border-4 border-chip-200 border-t-chip-500 mx-auto mb-4"></div>
                            <span class="absolute inset-0 flex items-center justify-center text-2xl">ü•î</span>
                        </div>
                        <p id="status-text" class="font-medium text-gray-600">Loading the crunchiest database...</p>
                    </div>

                    <!-- Inline News -->
                    <div id="inline-news" class="hidden">
                        <div class="flex items-center gap-3 mb-6">
                            <span class="text-3xl">üì∞</span>
                            <h2 class="text-2xl font-display font-bold text-gray-800">Latest Chip News</h2>
                        </div>
                        <div id="inline-news-articles">
                            <p class="text-gray-500">Loading the freshest chip news...</p>
                        </div>
                    </div>

                    <!-- Search Results -->
                    <div id="search-results" class="hidden"></div>

                    <!-- Article View -->
                    <div id="article-view" class="hidden">
                         <button id="back-button" class="mb-6 inline-flex items-center gap-2 bg-gradient-to-r from-chip-500 to-chip-600 text-white py-2.5 px-5 rounded-xl font-medium hover:from-chip-600 hover:to-chip-700 transition-all shadow-md hover:shadow-lg">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path></svg>
                            Back to Search
                         </button>
                         <article id="article-content" class="prose lg:prose-xl max-w-none prose-headings:font-display prose-headings:text-gray-800 prose-a:text-chip-600"></article>
                    </div>
                </main>
            </div>

            <!-- Sidebar Column -->
            <div class="lg:w-80 lg:flex-shrink-0">
                <!-- Chip of the Day Section -->
                <section id="chip-of-the-day" class="relative overflow-hidden bg-gradient-to-br from-amber-100 via-orange-100 to-yellow-100 p-6 rounded-2xl shadow-xl border border-amber-200/50">
                    <div class="absolute top-0 right-0 w-32 h-32 bg-gradient-to-br from-chip-300/30 to-transparent rounded-full -translate-y-1/2 translate-x-1/2"></div>
                    <div class="absolute bottom-0 left-0 w-24 h-24 bg-gradient-to-tr from-amber-300/30 to-transparent rounded-full translate-y-1/2 -translate-x-1/2"></div>
                    <div class="relative">
                        <div class="flex items-center gap-2 mb-4">
                            <span class="text-3xl animate-bounce">ü•î</span>
                            <h2 class="text-xl font-display font-bold text-amber-900">Chip of the Day</h2>
                        </div>
                        <div id="chip-of-day-content">
                            <div class="flex items-center gap-2 text-amber-700">
                                <div class="animate-pulse w-4 h-4 bg-amber-400 rounded-full"></div>
                                <p>Discovering today's chip...</p>
                            </div>
                        </div>
                    </div>
                </section>
            </div>

        </div>

        <footer class="text-center mt-12 py-6 border-t border-amber-200/50">
            <p class="text-gray-500 text-sm flex items-center justify-center gap-2">
                <span>Made with</span>
                <span class="text-red-500">‚ù§Ô∏è</span>
                <span>and</span>
                <span>ü•î</span>
                <span>‚Ä¢ Powered by your browser</span>
            </p>
        </footer>
    </div>

    <script>
        // --- DATABASE SETUP (Dexie.js) ---
        const db = new Dexie('EncyclopediaDB');
        db.version(3).stores({
            articles: 'id, title, content',
            invertedIndex: 'word, *ids'
        });

        // --- UI ELEMENTS ---
        const statusDiv = document.getElementById('status');
        const statusText = document.getElementById('status-text');
        const statusSpinner = document.getElementById('status-spinner');
        const searchInput = document.getElementById('search-input');
        const searchResultsDiv = document.getElementById('search-results');
        const articleViewDiv = document.getElementById('article-view');
        const articleContentDiv = document.getElementById('article-content');

        // --- NEWS SECTION ---
        async function loadNews() {
            const inlineNewsDiv = document.getElementById('inline-news-articles');
            try {
                const response = await fetch('news.json');
                if (!response.ok) throw new Error('News not available');
                const newsData = await response.json();
                if (!newsData || newsData.length === 0) {
                    inlineNewsDiv.innerHTML = '<p>No news found.</p>';
                    return;
                }
                let html = '';
                newsData.forEach((article, index) => {
                    const date = article.publishedAt ? new Date(article.publishedAt).toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' }) : '';
                    html += `<div class="news-card mb-4 p-5 bg-gradient-to-r from-white to-amber-50/50 rounded-xl border border-amber-100 shadow-sm hover:shadow-md transition-all duration-300">
                        <a href="${article.url}" target="_blank" class="text-lg font-semibold text-gray-800 hover:text-chip-600 transition-colors block leading-tight">${article.title}</a>
                        ${date ? `<p class="mt-2 text-xs font-medium text-amber-600 flex items-center gap-1"><svg class="w-3 h-3" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M6 2a1 1 0 00-1 1v1H4a2 2 0 00-2 2v10a2 2 0 002 2h12a2 2 0 002-2V6a2 2 0 00-2-2h-1V3a1 1 0 10-2 0v1H7V3a1 1 0 00-1-1zm0 5a1 1 0 000 2h8a1 1 0 100-2H6z" clip-rule="evenodd"></path></svg>${date}</p>` : ''}
                        <p class="mt-2 text-gray-600 text-sm leading-relaxed">${article.snippet}</p>
                        ${article.score ? `<div class="mt-3 flex items-center gap-2">
                            <div class="flex gap-0.5">${'üî•'.repeat(Math.min(Math.floor(article.score/2), 5))}</div>
                            <span class="text-xs font-medium text-gray-500">Interest: ${article.score}/10</span>
                        </div>` : ''}
                    </div>`;
                });
                inlineNewsDiv.innerHTML = html;
            } catch (err) {
                inlineNewsDiv.innerHTML = `<p class="text-red-500">Failed to load news: ${err.message}</p>`;
            }
        }

        // --- CHIP OF THE DAY SECTION ---
        async function loadChipOfTheDay() {
            const chipDiv = document.getElementById('chip-of-day-content');
            try {
                const response = await fetch('chip_of_the_day.json');
                if (!response.ok) throw new Error('Chip of the day not available');
                const chipData = await response.json();
                
                // Create Google search URL
                const searchUrl = `https://www.google.com/search?q=${encodeURIComponent('"' + chipData.chip_name + '" chips')}`;
                
                let html = '<div class="flex gap-4">';
                
                // Image display disabled - keeping generation for future use
                // if (chipData.image_url) {
                //     html += `
                //         <div class="flex-shrink-0">
                //             <a href="${searchUrl}" target="_blank" rel="noopener noreferrer">
                //                 <img src="${chipData.image_url}" 
                //                      alt="${chipData.chip_name}" 
                //                      class="w-32 h-32 object-cover rounded-lg shadow-md hover:opacity-80 transition-opacity"
                //                      onerror="this.style.display='none'">
                //             </a>
                //         </div>
                //     `;
                // }
                
                html += `
                    <div>
                        <h3 class="text-xl font-display font-bold text-amber-900 mb-3">
                            <a href="${searchUrl}" target="_blank" rel="noopener noreferrer" class="hover:text-chip-600 transition-colors">${chipData.chip_name}</a>
                        </h3>
                        <p class="text-gray-700 text-sm leading-relaxed">${chipData.description}</p>
                        ${chipData.date ? `<p class="mt-3 text-xs font-medium text-amber-600/70 flex items-center gap-1">
                            <svg class="w-3 h-3" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M6 2a1 1 0 00-1 1v1H4a2 2 0 00-2 2v10a2 2 0 002 2h12a2 2 0 002-2V6a2 2 0 00-2-2h-1V3a1 1 0 10-2 0v1H7V3a1 1 0 00-1-1zm0 5a1 1 0 000 2h8a1 1 0 100-2H6z" clip-rule="evenodd"></path></svg>
                            ${chipData.date}
                        </p>` : ''}
                    </div>
                </div>`;
                
                chipDiv.innerHTML = html;
            } catch (err) {
                chipDiv.innerHTML = `<p class="text-amber-700/60 text-sm">No chip of the day available yet.</p>`;
            }
        }

        window.addEventListener('DOMContentLoaded', () => {
            loadNews();
            loadChipOfTheDay();
        });
        const backButton = document.getElementById('back-button');

        // --- CORE LOGIC ---
        function tokenize(text) {
            const stopWords = new Set(['a', 'an', 'the', 'and', 'it', 'is', 'in', 'of', 'to', 'for', 'on', 'with', 'as', 'by', 'at']);
            return text
                .toLowerCase()
                .replace(/[^\w\s]/g, '')
                .split(/\s+/)
                .filter(word => word.length > 2 && !stopWords.has(word));
        }

        async function buildIndex(chipData) {
            statusText.textContent = 'Indexing content...';
            const articleIds = Object.keys(chipData);
            const invertedIndex = {};
            
            for (let i = 0; i < articleIds.length; i++) {
                const id = articleIds[i];
                statusText.textContent = `Indexing article ${i + 1} of ${articleIds.length}: ${id}`;
                
                const articleData = chipData[id];
                const { title, content } = articleData;
                
                await db.articles.put({ id, title, content });

                const uniqueWords = new Set(tokenize(title + ' ' + content));
                uniqueWords.forEach(word => {
                    if (!invertedIndex[word]) {
                        invertedIndex[word] = [];
                    }
                    invertedIndex[word].push(id);
                });
            }
            
            statusText.textContent = 'Saving index to database...';
            const indexEntries = Object.entries(invertedIndex).map(([word, ids]) => ({ word, ids }));
            await db.invertedIndex.bulkPut(indexEntries);

            console.log('Indexing complete!');
        }
        
        async function search(query) {
            const cleanQuery = query.toLowerCase().trim();
            if (cleanQuery.length < 3) {
                searchResultsDiv.innerHTML = '<p class="text-gray-500 text-center py-4">Please enter at least 3 characters.</p>';
                showView('search');
                return;
            }
            
            const result = await db.invertedIndex.get(cleanQuery);
            
            if (result && result.ids.length > 0) {
                const articles = await db.articles.where('id').anyOf(result.ids).toArray();
                let html = `<div class="flex items-center gap-3 mb-6">
                    <span class="text-2xl">üîç</span>
                    <h2 class="text-xl font-display font-bold text-gray-800">Results for "${cleanQuery}"</h2>
                    <span class="text-sm text-gray-500 bg-gray-100 px-2 py-0.5 rounded-full">${articles.length} found</span>
                </div>`;
                html += '<ul class="space-y-3">';
                articles.forEach(article => {
                    html += `
                        <li class="p-4 bg-gradient-to-r from-white to-amber-50/30 border border-amber-100 rounded-xl hover:shadow-md hover:border-chip-200 cursor-pointer transition-all duration-200" data-id="${article.id}">
                            <h3 class="font-semibold text-lg text-gray-800 hover:text-chip-600">${article.title}</h3>
                            <p class="text-sm text-gray-600 mt-1">${article.content.substring(0, 120)}...</p>
                        </li>
                    `;
                });
                html += '</ul>';
                searchResultsDiv.innerHTML = html;
            } else {
                searchResultsDiv.innerHTML = `<div class="text-center py-8">
                    <span class="text-4xl mb-3 block">ü§î</span>
                    <p class="text-gray-600">No chips found for "${cleanQuery}"</p>
                    <p class="text-gray-400 text-sm mt-1">Try a different search term</p>
                </div>`;
            }
            showView('search');
        }

        async function displayArticle(id) {
            const article = await db.articles.get(id);
            if (article) {
                articleContentDiv.innerHTML = marked.parse(article.content);
                showView('article');
            }
        }
        
        function showView(viewName) {
            const inlineNewsDiv = document.getElementById('inline-news');
            articleViewDiv.classList.add('hidden', 'opacity-0');
            searchResultsDiv.classList.add('hidden', 'opacity-0');
            statusDiv.classList.add('hidden');
            inlineNewsDiv.classList.add('hidden');
            
            if (viewName === 'search') {
                searchResultsDiv.classList.remove('hidden');
                setTimeout(() => searchResultsDiv.classList.remove('opacity-0'), 10);
            } else if (viewName === 'article') {
                articleViewDiv.classList.remove('hidden');
                setTimeout(() => articleViewDiv.classList.remove('opacity-0'), 10);
            } else if (viewName === 'news') {
                inlineNewsDiv.classList.remove('hidden');
            }
        }
        
        // --- EVENT LISTENERS ---
        let searchTimeout;
        searchInput.addEventListener('input', () => {
            clearTimeout(searchTimeout);
            searchTimeout = setTimeout(() => {
                const query = searchInput.value;
                if (query) {
                    search(query);
                } else {
                    showView('news');
                }
            }, 300);
        });
        
        searchResultsDiv.addEventListener('click', (e) => {
            const listItem = e.target.closest('li');
            if (listItem && listItem.dataset.id) {
                displayArticle(listItem.dataset.id);
            }
        });
        
        backButton.addEventListener('click', () => {
             showView('search');
        });

        // --- INITIALIZATION ---
        async function initialize() {
            try {
                await db.open(); 
                // Always clear the database and re-index
                await db.articles.clear();
                await db.invertedIndex.clear();
                console.log('Database cleared. Loading chip data from JSON file.');
                
                // Fetch the chip data from JSON file
                const response = await fetch('chip-data.json');
                const chipData = await response.json();
                
                await buildIndex(chipData);
            } catch (error) {
                 console.error("Failed to initialize database:", error);
                 console.log("Attempting to recover by deleting database and re-indexing.");
                 await db.close();
                 await db.delete();
                 await db.open();

                 // Fetch the chip data from JSON file
                 const response = await fetch('chip-data.json');
                 const chipData = await response.json();

                 await buildIndex(chipData);
            } finally {
                statusDiv.classList.add('hidden');
                showView('news');
            }
        }

        window.onload = initialize;
    </script>
</body>
</html>
