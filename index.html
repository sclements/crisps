<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Serverless Chip-cyclopedia</title>
    <!-- Tailwind CSS for styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Dexie.js: A wrapper for IndexedDB -->
    <script src="https://unpkg.com/dexie@3/dist/dexie.js"></script>
    <!-- marked.js: A Markdown to HTML parser -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <style>
        /* Simple transition for a smoother UI */
        #article-view, #search-results { transition: opacity 0.3s ease-in-out; }
    </style>
</head>
<body class="bg-yellow-50 text-gray-800 font-sans antialiased">

    <div class="container mx-auto p-4 md:p-8 max-w-4xl">
        <header class="mb-8 text-center">
            <h1 class="text-4xl md:text-5xl font-bold text-yellow-800">The Chip-cyclopedia</h1>
            <p class="text-gray-600 mt-2">A completely serverless, offline-capable database of crisps.</p>
        </header>

        <!-- Search Bar -->
        <div class="relative mb-6">
            <input type="text" id="search-input" placeholder="Search for chips like 'kettle', 'lentil', or 'pita'..."
                   class="w-full p-4 pl-10 text-lg border-2 border-gray-300 rounded-full focus:ring-2 focus:ring-yellow-500 focus:border-yellow-500 outline-none transition duration-300">
            <svg class="w-6 h-6 absolute left-3 top-1/2 -translate-y-1/2 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path></svg>
        </div>

        <!-- Main Content Area -->
        <main id="content-area" class="bg-white p-6 rounded-lg shadow-lg min-h-[300px]">
            <!-- Indexing Status -->
            <div id="status" class="text-center text-gray-500 p-8">
                <div id="status-spinner" class="animate-spin rounded-full h-12 w-12 border-b-2 border-yellow-500 mx-auto mb-4"></div>
                <p id="status-text">Initializing Chip-cyclopedia...</p>
            </div>
            
            <!-- Search Results -->
            <div id="search-results" class="hidden"></div>
            
            <!-- Article View -->
            <div id="article-view" class="hidden">
                 <button id="back-button" class="mb-4 bg-yellow-500 text-white py-2 px-4 rounded-lg hover:bg-yellow-600 transition">&larr; Back to Search</button>
                 <article id="article-content" class="prose lg:prose-xl max-w-none"></article>
            </div>
        </main>
        
        <footer class="text-center mt-8 text-gray-500 text-sm">
            <p>Powered by JavaScript, Dexie.js, and your browser's local database.</p>
        </footer>
    </div>

    <script>
        // --- DATABASE SETUP (Dexie.js) ---
        const db = new Dexie('EncyclopediaDB');
        db.version(3).stores({
            articles: 'id, title, content',
            invertedIndex: 'word, *ids'
        });
        
        // --- UI ELEMENTS ---
        const statusDiv = document.getElementById('status');
        const statusText = document.getElementById('status-text');
        const statusSpinner = document.getElementById('status-spinner');
        const searchInput = document.getElementById('search-input');
        const searchResultsDiv = document.getElementById('search-results');
        const articleViewDiv = document.getElementById('article-view');
        const articleContentDiv = document.getElementById('article-content');
        const backButton = document.getElementById('back-button');

        // --- CORE LOGIC ---
        
        function tokenize(text) {
            const stopWords = new Set(['a', 'an', 'the', 'and', 'it', 'is', 'in', 'of', 'to', 'for', 'on', 'with', 'as', 'by', 'at']);
            return text
                .toLowerCase()
                .replace(/[^\w\s]/g, '')
                .split(/\s+/)
                .filter(word => word.length > 2 && !stopWords.has(word));
        }

        async function buildIndex(chipData) {
            statusText.textContent = 'Indexing content...';
            const articleIds = Object.keys(chipData);
            const invertedIndex = {};
            
            for (let i = 0; i < articleIds.length; i++) {
                const id = articleIds[i];
                statusText.textContent = `Indexing article ${i + 1} of ${articleIds.length}: ${id}`;
                
                const articleData = chipData[id];
                const { title, content } = articleData;
                
                await db.articles.put({ id, title, content });

                const uniqueWords = new Set(tokenize(title + ' ' + content));
                uniqueWords.forEach(word => {
                    if (!invertedIndex[word]) {
                        invertedIndex[word] = [];
                    }
                    invertedIndex[word].push(id);
                });
            }
            
            statusText.textContent = 'Saving index to database...';
            const indexEntries = Object.entries(invertedIndex).map(([word, ids]) => ({ word, ids }));
            await db.invertedIndex.bulkPut(indexEntries);

            console.log('Indexing complete!');
        }
        
        async function search(query) {
            const cleanQuery = query.toLowerCase().trim();
            if (cleanQuery.length < 3) {
                searchResultsDiv.innerHTML = '<p class="text-gray-500">Please enter at least 3 characters.</p>';
                return;
            }
            
            const result = await db.invertedIndex.get(cleanQuery);
            
            if (result && result.ids.length > 0) {
                const articles = await db.articles.where('id').anyOf(result.ids).toArray();
                let html = `<h2 class="text-2xl font-bold mb-4">Search Results for "${cleanQuery}"</h2>`;
                html += '<ul class="space-y-3">';
                articles.forEach(article => {
                    html += `
                        <li class="p-4 border rounded-lg hover:bg-gray-50 cursor-pointer" data-id="${article.id}">
                            <h3 class="font-semibold text-lg text-yellow-700">${article.title}</h3>
                            <p class="text-sm text-gray-600">${article.content.substring(0, 100)}...</p>
                        </li>
                    `;
                });
                html += '</ul>';
                searchResultsDiv.innerHTML = html;
            } else {
                searchResultsDiv.innerHTML = `<p class="text-gray-500">No results found for "${cleanQuery}".</p>`;
            }
        }

        async function displayArticle(id) {
            const article = await db.articles.get(id);
            if (article) {
                articleContentDiv.innerHTML = marked.parse(article.content);
                showView('article');
            }
        }
        
        function showView(viewName) {
            articleViewDiv.classList.add('hidden', 'opacity-0');
            searchResultsDiv.classList.add('hidden', 'opacity-0');
            statusDiv.classList.add('hidden');
            
            if (viewName === 'search') {
                searchResultsDiv.classList.remove('hidden');
                setTimeout(() => searchResultsDiv.classList.remove('opacity-0'), 10);
            } else if (viewName === 'article') {
                articleViewDiv.classList.remove('hidden');
                setTimeout(() => articleViewDiv.classList.remove('opacity-0'), 10);
            }
        }
        
        // --- EVENT LISTENERS ---
        let searchTimeout;
        searchInput.addEventListener('input', () => {
            clearTimeout(searchTimeout);
            searchTimeout = setTimeout(() => {
                const query = searchInput.value;
                if (query) {
                    search(query);
                } else {
                    searchResultsDiv.innerHTML = '<p class="text-gray-500">Start typing to search for a chip.</p>';
                }
            }, 300);
        });
        
        searchResultsDiv.addEventListener('click', (e) => {
            const listItem = e.target.closest('li');
            if (listItem && listItem.dataset.id) {
                displayArticle(listItem.dataset.id);
            }
        });
        
        backButton.addEventListener('click', () => {
             showView('search');
        });

        // --- INITIALIZATION ---
        async function initialize() {
            try {
                await db.open(); 
                // Always clear the database and re-index
                await db.articles.clear();
                await db.invertedIndex.clear();
                console.log('Database cleared. Loading chip data from JSON file.');
                
                // Fetch the chip data from JSON file
                const response = await fetch('chip-data.json');
                const chipData = await response.json();
                
                await buildIndex(chipData);
            } catch (error) {
                 console.error("Failed to initialize database:", error);
                 console.log("Attempting to recover by deleting database and re-indexing.");
                 await db.close();
                 await db.delete();
                 await db.open();
                 
                 // Fetch the chip data from JSON file
                 const response = await fetch('chip-data.json');
                 const chipData = await response.json();
                 
                 await buildIndex(chipData);
            } finally {
                statusDiv.classList.add('hidden');
                searchResultsDiv.innerHTML = '<p class="text-gray-500">Start typing to search for a chip.</p>';
                showView('search');
            }
        }
        
        window.onload = initialize;

    </script>
</body>
</html>
